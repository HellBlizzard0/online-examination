<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:util="http://java.sun.com/jsf/composite/util">
<h:head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<h:outputStylesheet library="css" name="styles.css" />
	<h:outputStylesheet library="css" name="grid.css" />
	<h:outputStylesheet library="css" name="bootstrap.css" />
	<h:outputScript name="utilities.js" library="javascript" target="head" />
	<script type="text/javascript">
		window.onkeypress = function(e) {
			var keyCode = window.event.keyCode || e.keyCode || e.which;
			if (keyCode == '13') {
				document.getElementById('letterMiniSearchFormId:searchBtnId')
						.click();
				return false;
			}
		};

		window.onunload = unloadPage;
		function unloadPage() {
			window.opener.releaseMask();
		}
		function downloadFile() {
			downloadedFileParamId = document
					.getElementById('letterMiniSearchFormId:downloadedFileParamId').value;
			openDownloadFile('#{letterMiniSearch.boolServerDownloadPath}',
					downloadedFileParamId);
			return false;
		}

		function handleDownloadFiles(e) {
			openDownloadPopupFlagId = document
					.getElementById('letterMiniSearchFormId:openDownloadPopupFlagId').value;
			openDownloadDialogueFlagId = document
					.getElementById('letterMiniSearchFormId:openDownloadDialogueFlagId').value;

			if (e.status == 'success') {
				if (openDownloadPopupFlagId == 'true') {
					downloadFile();
				} else if (openDownloadDialogueFlagId == 'true') {
					PF('dlg').show();
				}
			}
		}

		function closeWindow() {
			window.close();
		}
	</script>
</h:head>
<h:body styleClass="screenBg" onunload="unloadPage();">
	<h:form id="letterMiniSearchFormId" dir="#{msgs.dir}">
		<ui:decorate template="/Main/TemplateMiniSearch.xhtml">
			<table border="0" cellpadding="0" cellspacing="3" width="100%" class="bgcolor-pup">
				<tr valign="top">
					<td width="100%">
						<table border="0" cellpadding="0" cellspacing="0" width="100%">


							<tr>
								<td class="screenTitle">
									<h:outputText value="#{letterMiniSearch.screenTitle}" />
								</td>
							</tr>



							<tr>
								<td width="100%" height="5" />
							</tr>

							<tr>
								<td colspan="2">
									<table class="sectionTitle" border="0" cellpadding="0" cellspacing="0">
										<tr>
											<td>
												<h:outputText value="#{msgs.label_lettersInformation}" />
											</td>
										</tr>
									</table>
								</td>
							</tr>
							<tr>
								<td width="100%" height="5" />
							</tr>

							<tr>
								<td align="center" width="100%">
									<h:panelGroup id="followUpsId">

										<p:dataTable styleClass="table_with_filter" paginator="true" style="width:100%;" id="lettersDataTableId" widgetVar="lettersDataTableId" rowIndexVar="index" rows="10" var="row" value="#{letterMiniSearch.lettersList}" emptyMessage="#{msgs.error_noData}" reflow="true">
											<p:ajax event="filter" ignoreAutoUpdate="true" />
											<p:column styleClass='centerText'>
												<f:facet name="header">#</f:facet>
                                #{index + 1}
                            </p:column>
											<p:column styleClass='centerText' filterBy="#{row.letterNumber}" filterMatchMode="contains">

												<f:facet name="header">#{msgs.label_letterNumber}</f:facet>
												<h:outputText value="#{row.letterNumber}" />
											</p:column>
											<p:column styleClass='centerText' filterBy="#{row.fileNumber}" filterMatchMode="contains">
												<f:facet name="header">#{msgs.label_fileNumber}</f:facet>
												<h:outputText value="#{row.fileNumber}" />
											</p:column>
											<p:column styleClass='centerText' filterBy="#{row.letterDateString}" filterMatchMode="contains">
												<f:facet name="header">#{msgs.label_dateD}</f:facet>
												<h:outputText value="#{row.letterDateString}" />
											</p:column>
											<p:column styleClass='centerText' filterBy="#{row.type}" filterMatchMode="equals">
												<f:facet name="header">#{msgs.label_letterType}</f:facet>
												<f:facet name="filter">
													<p:selectOneMenu id="selectMenuId" onchange="PF('lettersDataTableId').filter()" style="width:150px;">
														<f:selectItem itemLabel="#{msgs.label_all}" itemValue="" />
														<f:selectItem itemLabel="#{msgs.label_issued}" itemValue="1" />
														<f:selectItem itemLabel="#{msgs.label_incoming}" itemValue="0" />
													</p:selectOneMenu>
												</f:facet>
												<h:outputText value="#{row.type == 1 ? msgs.label_issued : msgs.label_incoming}" />
											</p:column>
											<p:column styleClass='centerText' filterBy="#{row.organization}" filterMatchMode="contains">
												<f:facet name="header">#{msgs.label_unitSource}</f:facet>
												<h:outputText value="#{row.organization}" />
											</p:column>
											<p:column styleClass='centerText' filterBy="#{row.notes}" filterMatchMode="contains">
												<f:facet name="header">#{msgs.label_comment}</f:facet>
												<h:outputText value="#{row.notes}" />
											</p:column>
											<p:column styleClass='centerText'>
												<f:facet name="header">#{msgs.label_archiveDocumentsShow}</f:facet>
												<h:commandButton styleClass="btn btn-success" id="archiveBtnDownloadId" value="&#xf0c5;">
													<f:ajax render="letterMiniSearchFormId:downloadDlgPanelId  letterMiniSearchFormId:fileArchivingParamId letterMiniSearchFormId:downloadedFileParamId letterMiniSearchFormId:openDownloadPopupFlagId letterMiniSearchFormId:openDownloadDialogueFlagId" listener="#{letterMiniSearch.getDownloadedAttachmentsIdList(row.id)}" onevent="handleDownloadFiles" />
												</h:commandButton>
												<h:panelGroup id="downloadDataId">

												</h:panelGroup>
											</p:column>

										</p:dataTable>
										<h:inputHidden id="fileArchivingParamId" value="#{letterMiniSearch.fileArchivingParam}" />
										<h:inputHidden id="downloadedFileParamId" value="#{letterMiniSearch.downloadFileParamId}" />
										<h:inputHidden id="openDownloadPopupFlagId" value="#{letterMiniSearch.openDownloadPopupFlag}" />
										<h:inputHidden id="openDownloadDialogueFlagId" value="#{letterMiniSearch.openDownloadDialogueFlag}" />

									</h:panelGroup>
								</td>
							</tr>
						</table>

					</td>
				</tr>
				<tr>
					<td width="100%" height="5" />
				</tr>
				<tr>
					<td>
						<table class="actionsSection" border="0" cellpadding="0" cellspacing="0" width="100%">
							<tr>
								<td>


									<h:commandButton id="backBtnId" styleClass="btn btn-default" value="&#xf3e5; #{msgs.label_goBack}" onclick="return closeWindow();" />
								</td>
							</tr>
						</table>
					</td>
				</tr>

			</table>
			<h:panelGroup id="downloadDlgPanelId">
				<p:dialog dir="#{msgs.dir}" header="#{msgs.label_archiveDocumentsShow}" id="dlgId" widgetVar="dlg" modal="true" height="180px;" width="720px">
					<h:panelGroup id="internalDlgPanelId" rendered="#{letterMiniSearch.attachmentList.size() > 1}">
						<table width="100%">
							<tr>
								<td>
									<p:dataTable tableStyle="table-layout:auto" reflow="true" liveResize="true" paginatorPosition="bottom" id="fileListIds" paginator="true" style="width:100%" rowIndexVar="index" rows="10" var="row" value="#{letterMiniSearch.attachmentList}" rowHover="true">
										<p:column styleClass='centerText'>
											<f:facet name="header">#</f:facet>
		                                    #{index + 1}
	                                   	</p:column>
										<p:column styleClass='centerText'>
											<f:facet name="header">
													#{msgs.label_fileName}
												</f:facet>
											<h:outputText value="#{row.fileName}" />
										</p:column>
										<p:column styleClass='centerText'>
											<f:facet name="header">
												#{msgs.label_download}
											</f:facet>
											<h:commandButton styleClass="btn btn-success" value="&#xf019; #{msgs.label_download}">
												<f:ajax render="letterMiniSearchFormId:internalDlgPanelId letterMiniSearchFormId:downloadedFileParamId" listener="#{letterMiniSearch.getDownloadParam(row.attachmentId)}" onevent="function(e){if(e.status == 'success') return downloadFile();}" />
											</h:commandButton>
										</p:column>
										<p:column styleClass='centerText' rendered="#{letterMiniSearch.deletePrivilage}">
											<f:facet name="header">
												#{msgs.label_delete}
											</f:facet>
											<h:commandButton styleClass="btn btn-trans-icon" value="&#xf00d;">
												<f:ajax render="letterMiniSearchFormId:internalDlgPanelId letterMiniSearchFormId:downloadedFileParamId" listener="#{letterMiniSearch.deleteAttachment(row)}" />
											</h:commandButton>
										</p:column>
									</p:dataTable>
								</td>
							</tr>
						</table>
					</h:panelGroup>
				</p:dialog>
			</h:panelGroup>
		</ui:decorate>
	</h:form>
</h:body>
</html>